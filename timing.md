# Timing requirements for the whole system

## IR sensor circuit

### 1. Comparator approach

Normally, with the optimal OpAmp, there will be no input capacitance. But there will be in the real OpAmp

![alt text](image.png)

With the new comparator MCP656X

$$
C_{differential-input} = {2pF}
$$
$$
C_{common-mode-input} = {4pF}
$$

![alt text](image-1.png)


## 1. Variables
* **$R_L$:** The Load Resistor connected to the photodiode (converts current to voltage).
* **$C_{total}$:** The total capacitance at the input node.
    $$C_{total} = C_{sensor} + C_{comparator} + C_{stray}$$
    *($\approx 1.8\text{pF} + 6\text{pF} + 2\text{pF} \approx 10\text{pF}$)*
* $I_{ph}$: The photocurrent generated by the bullet/object (depends on light intensity).
* $V_{max}$: The maximum theoretical voltage the signal would reach if given infinite time.
    $$V_{max} = I_{ph} \times R_L$$
* $V_{th}$: The Comparator Threshold Voltage ($V_{TL}$) where the switch occurs.

---

## 2. The Time Constant ($\tau$)
The fundamental speed limit of the input node is defined by the RC product.

$$\tau = R_L \times C_{total}$$

* **Rule of Thumb:** The signal reaches 63% of its max value in $1\tau$.
* **Settling:** The signal is considered "stable" (99%) after $5\tau$.

---

## 3. The "Time to Trigger" Formula (Input Delay)
Since the comparator triggers at a specific voltage ($V_{th}$), we don't need to wait for the signal to rise completely. We only need the time it takes to cross $V_{th}$.

The voltage rise follows an exponential curve:
$$V(t) = V_{max} \left( 1 - e^{-\frac{t}{\tau}} \right)$$

**Solving for time ($t$):**

$$t_{delay\_input} = -R_L \times C_{total} \times \ln\left( 1 - \frac{V_{th}}{I_{ph} \times R_L} \right)$$

### Design Implication:
To make the circuit faster, you must ensure your signal ($I_{ph} \times R_L$) is significantly larger than your threshold ($V_{th}$). This minimizes the term inside the natural log ($\ln$).

---

## 4. Total System Response Time
The total time from "Light Event" to "Output Switching" is the sum of the input rise time and the chip's internal delay.

$$t_{total} = t_{delay\_input} + t_{propagation}$$

* **$t_{delay\_input}$:** Calculated above (typically 100ns - 1Âµs depending on resistor).
* **$t_{propagation}$:** Fixed by the MCP6561 chip (typically **56 ns**).


## 1. The Goal
We want to design a comparator circuit that:
* Outputs **LOW** when the input signal rises above a High Threshold ($V_{TH}$).
* Outputs **HIGH** when the input signal drops below a Low Threshold ($V_{TL}$).
* The difference between these thresholds is the **Hysteresis Width** ($V_{Hyst}$), which prevents noise from causing rapid switching (chattering).

## 2. The Circuit Topology
The circuit consists of:
1.  **Input ($V_{in}$):** Connected to the Inverting Pin ($V_-$).
2.  **Voltage Divider ($R_3, R_2$):** Connected to the Non-Inverting Pin ($V_+$).
    * $R_3$ connects $V_+$ to $V_{CC}$.
    * $R_2$ connects $V_+$ to Ground.
3.  **Feedback Resistor ($R_F$):** Connects the Output ($V_{out}$) back to the Non-Inverting Pin ($V_+$).

## 3. Derivation Method (Thevenin & Superposition)

To solve for the resistors, we simplify the circuit seen by the $V_+$ pin.

### Step 1: Thevenin Transformation
We view the voltage divider ($R_2, R_3$) as a single voltage source with an internal resistance.

* **Thevenin Voltage ($V_{ref}$):** The voltage at $V_+$ if $R_F$ were removed.
    $$V_{ref} = V_{CC} \times \frac{R_2}{R_2 + R_3}$$

* **Thevenin Resistance ($R_{eq}$):** The equivalent resistance of $R_2$ and $R_3$.
    * *Note:* When calculating equivalent resistance, independent sources ($V_{CC}$) are treated as Shorts to Ground. Therefore, $R_2$ and $R_3$ appear in **parallel**.
    $$R_{eq} = R_2 \parallel R_3 = \frac{R_2 \cdot R_3}{R_2 + R_3}$$

### Step 2: The "Master Equation" (Superposition)
Now, the $V_+$ pin is driven by two sources fighting each other:
1.  **$V_{ref}$** (Thevenin source) acting through $R_{eq}$.
2.  **$V_{out}$** (Comparator Output) acting through $R_F$.

Using Superposition, the voltage at the pin ($V_+$) is:
$$V_+ = \underbrace{V_{ref} \left( \frac{R_F}{R_F + R_{eq}} \right)}_{\text{Contribution from } V_{ref}} + \underbrace{V_{out} \left( \frac{R_{eq}}{R_F + R_{eq}} \right)}_{\text{Contribution from } V_{out}}$$

---

## 4. Defining the Thresholds

The comparator switches states when $V_{in}$ crosses $V_+$. Since $V_{out}$ changes, $V_+$ changes, creating the two thresholds.

### Case A: High Threshold ($V_{TH}$)
Occurs when the Output is currently **HIGH** ($V_{out} = V_{CC}$). The feedback pulls the threshold UP.
$$V_{TH} = V_{ref} \left( \frac{R_F}{R_F + R_{eq}} \right) + V_{CC} \left( \frac{R_{eq}}{R_F + R_{eq}} \right)$$

### Case B: Low Threshold ($V_{TL}$)
Occurs when the Output is currently **LOW** ($V_{out} = 0V$). The feedback pulls the threshold DOWN.
$$V_{TL} = V_{ref} \left( \frac{R_F}{R_F + R_{eq}} \right) + 0$$

---

## 5. Design Equations (Solving for Resistors)

We can rearrange the threshold equations to solve for the component values.

### A. Calculate $R_{eq}$ (Controls Hysteresis Width)
Subtracting the $V_{TL}$ equation from the $V_{TH}$ equation isolates the hysteresis term:
$$V_{TH} - V_{TL} = V_{Hyst}$$
$$V_{Hyst} = V_{CC} \left( \frac{R_{eq}}{R_F + R_{eq}} \right)$$

**Rearranging to solve for $R_{eq}$:**
$$R_{eq} = R_F \times \frac{V_{Hyst}}{V_{CC} - V_{Hyst}}$$

### B. Calculate $R_3$ (Top Resistor)
From the $V_{TL}$ equation (Case B), we know that $V_{TL}$ is simply a scaled version of $V_{ref}$. However, it is easier to solve using the Voltage Divider rule directly.

$$R_3 = R_{eq} \times \frac{V_{CC}}{V_{ref\_target}}$$
*Where $V_{ref\_target}$ is the "Baseline" voltage derived from:*
$$V_{ref\_target} = V_{TL} \times \frac{R_F + R_{eq}}{R_F}$$

### C. Calculate $R_2$ (Bottom Resistor)
$$R_2 = R_{eq} \times \frac{V_{CC}}{V_{CC} - V_{ref\_target}}$$

---

## 6. Design Workflow Example

**Scenario:**
* **Supply ($V_{CC}$):** 5.0V
* **Target $V_{TL}$:** 2.0V (Turn ON when signal drops below this)
* **Target $V_{TH}$:** 3.0V (Turn OFF when signal rises above this)

**Step 1: Determine Hysteresis**
$$V_{Hyst} = 3.0V - 2.0V = 1.0V$$

**Step 2: Choose Feedback Resistor**
Pick a large value to save power.
$$R_F = 100\text{k}\Omega$$

**Step 3: Calculate $R_{eq}$**
$$R_{eq} = 100\text{k} \times \frac{1.0}{5.0 - 1.0} = 25\text{k}\Omega$$

**Step 4: Calculate $V_{ref}$ (Thevenin Voltage)**
$$V_{ref} = 2.0V \times \frac{100\text{k} + 25\text{k}}{100\text{k}} = 2.5V$$

**Step 5: Calculate Final Resistors**
* **$R_3$:** $25\text{k} \times \frac{5.0}{2.5} = 50\text{k}\Omega$
* **$R_2$:** $25\text{k} \times \frac{5.0}{5.0 - 2.5} = 50\text{k}\Omega$